<table class='table table-hover borderless'>
  <tbody>
    <% favorites = (current_user.try(:followed_teams) || []) %>
    <% teams_by_sport.each do |sport_name, teams| %>
      <% unless teams.empty? %>
        <tr>
          <td>
            <h3 id="<%= sport_name.underscore if all %>"><a href="#Top"><span class="glyphicon-class glyphicon glyphicon-chevron-up"></span></a><%= sport_name %></h3>
          </td>
        </tr>
        <% teams.each do |team| %>
          <tr>
            <td><%= image_tag(team.image_url, size: '80') %></td>
            <td><h4><%= link_to(team.name, team) %></h4></td>
            <td>
              <div data-tab="<%= tab %>">
              <% if user_signed_in? %>
                <i class="fa fa-4x subscribe-star <%= favorites.include?(team) ? 'fa-star' : 'fa-star-o' %> team-<%= team.id %>" data-team-id='<%= team.id %>'></i>
              <% end %>
            </td>
          </tr>
        <% end %>
      <% end %>
    <% end %>
  </tbody>
</table>

<script type='text/javascript'>
  $('.subscribe-star').on('click', function() {
    var self = $(this);
    var teamId = $(this).data('team-id');
    var subscribed = $(this).hasClass('fa-star-o');
    var url = '';
    if (subscribed) {
      url = "/teams/" + teamId + "/subscribe";
    } else {
      url = "/teams/" + teamId + "/unsubscribe";
    };
    var div = $(this).closest('div').data('tab');
    var teamIdClass = '.team-' + teamId + '';
    $.ajax({
      url: url,
      type: 'PUT',
      data: {'id': teamId},
      success: function() {
        if ($(teamIdClass).hasClass('fa-star')) {
          $(teamIdClass).removeClass('fa-star');
          $(teamIdClass).addClass('fa-star-o');
        } else {
          $(teamIdClass).removeClass('fa-star-o');
          $(teamIdClass).addClass('fa-star');
        };
      }
    })
  });
</script>
